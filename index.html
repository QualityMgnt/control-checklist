<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Experience Controls</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Garamond', serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100vw;
            margin: 0;
            overflow-x: hidden; 
        }
        .container {
            background-color: #ffffff;
            border-radius: 0;
            box-shadow: none;
            width: 100vw;
            height: 100vh;
            max-width: none;
            max-height: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            box-sizing: border-box;
        }
        .top-nav {
            display: flex;
            flex-wrap: wrap;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            border-radius: 0;
            padding: 0.5rem 1rem;
            justify-content: flex-start;
            width: 100%;
            box-sizing: border-box;
        }
        .top-nav .tab-button {
            padding: 0.75rem 1.5rem;
            border-bottom: 3px solid transparent;
            border-left: none;
            text-align: center;
            flex-grow: 1;
            background-color: #7c3aed;
            color: white;
            margin: 0.25rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease-in-out;
        }
        .top-nav .tab-button:hover {
            background-color: #6d28d9;
        }
        .top-nav .tab-button.active {
            border-color: #ffffff;
            background-color: #5b21b6;
            color: white;
            border-bottom: 3px solid white;
            border-left: none;
        }
        .tab-content {
            display: none;
            padding: 1.5rem;
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .tab-content.active {
            display: block;
        }
        .input-field {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            width: 100%;
            box-sizing: border-box;
            font-size: 0.9rem;
        }
        .btn-primary {
            background-color: #7c3aed;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1-px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            background-color: #6d28d9;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5-px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #7c3aed;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #333;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            table-layout: auto;
        }
        th, td {
            border: 1px solid #0a113d;
            padding: 0.75rem;
            text-align: left;
            font-size: 10px;
            word-wrap: break-word;
            font-family: 'Garamond', serif;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
            white-space: normal;
            text-align: center;
        }
        tbody tr:nth-child(even) {
            background-color: #f3f4f6;
        }
        tbody tr:hover {
            background-color: #e5e7eb;
        }
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.25rem;
        }
        .action-buttons button {
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .action-buttons .review-btn {
            background-color: #22c55e;
            color: white;
        }
        .action-buttons .review-btn:hover {
            background-color: #16a34a;
        }
        .action-buttons .delete-btn {
            background-color: #ef4444;
            color: white;
        }
        .action-buttons .delete-btn:hover {
            background-color: #dc2626;
        }
        .pdf-export-content {
            display: none;
            padding: 1rem;
            background-color: white;
        }
        @media (max-width: 768px) {
            .container {
                width: 100%;
                border-radius: 0;
                box-shadow: none;
                min-height: 100vh;
            }
            .top-nav {
                flex-direction: row;
                justify-content: center;
                padding: 0.5rem;
            }
            .top-nav .tab-button {
                margin: 0.125rem;
                padding: 0.5rem 0.75rem;
            }
            .modal-content {
                width: 95%;
                padding: 1rem;
            }
            .overflow-x-auto {
                overflow-x: scroll;
            }
        }
        .status-green { background-color: #d1fae5; color: #065f46; font-weight: 600; }
        .status-red { background-color: #fee2e2; color: #991b1b; font-weight: 600; }
        .status-amber { background-color: #fef3c7; color: #92400e; font-weight: 600; }
        .status-gray { background-color: #e5e7eb; color: #374151; font-weight: 600; }
        .overdue-text { color: #dc2626; }
        
        td.status-cell {
            padding: 0;
            text-align: center;
        }
        .status-text {
            display: block;
            padding: 0.75rem;
            width: 100%;
            height: 100%;
        }
        .table-header-months, .table-header-quarters {
            text-align: center;
        }
        .pdf-signature-area {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            max-width: 400px;
        }
        .pdf-signature-area img {
            height: 60px;
            width: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .pdf-signature-area span {
            margin-left: 1rem;
            font-style: italic;
            color: #6b7280;
        }
        .signoff-table {
            border: 1px solid #e5e7eb;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .signoff-table td, .signoff-table th {
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            text-align: left;
            vertical-align: top;
        }
        .signoff-table img {
            max-width: 150px;
            height: auto;
        }
        .logo-display {
            width: 3cm;
            height: 1.5cm;
            margin-right: 1rem;
            border-radius: 0.5rem;
        }
        .header-logo {
            position: absolute;
            top: 1rem;
            right: 1rem;
            max-height: 40px;
        }
        .pdf-logo {
            position: absolute;
            top: 2rem;
            right: 2rem;
            max-height: 60px;
        }
        #excel-export-content {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: auto;
            height: auto;
        }
        .pdf-signoff-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
        }
        .pdf-signoff-table th, .pdf-signoff-table td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            font-size: 14px;
        }
        .pdf-signoff-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .pdf-signoff-table .signature-box {
            height: 60px;
            border: 1px solid #ccc;
            margin-top: 5px;
        }
        .dashboard-charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
    </style>
</head>
<body>

    <div id="loading-spinner" class="loading-spinner"></div>

    <div id="message-box" class="message-box"></div>

    <div id="login-page" class="w-full h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <div class="flex justify-center mb-4">
                <img id="login-logo-preview" class="h-20 w-auto hidden" src="" alt="Company Logo">
            </div>
            <h2 class="text-3xl font-bold text-center text-purple-600 mb-8">Login to Customer Experience Controls</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email" required class="input-field">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password" required class="input-field">
                    <a href="#" id="forgot-password" class="block text-sm text-purple-600 hover:underline mt-2 text-right">Forgot password?</a>
                </div>
                <button type="submit" class="btn-primary w-full">Login</button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Don't have an account? <a href="#" id="show-signup" class="text-purple-600 hover:underline">Sign Up</a>
                </p>
            </form>
        </div>
    </div>

    <div id="signup-page" class="w-full h-screen flex items-center justify-center bg-gray-100 hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <div class="flex justify-center mb-4">
                <img id="signup-logo-preview" class="h-20 w-auto hidden" src="" alt="Company Logo">
            </div>
            <h2 class="text-3xl font-bold text-center text-purple-600 mb-8">Create an Account</h2>
            <form id="signup-form" class="space-y-6">
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email" required class="input-field">
                </div>
                <div>
                    <label for="signup-fullname" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="signup-fullname" placeholder="Enter your full name" required class="input-field">
                </div>
                <div>
                    <label for="signup-department" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                    <select id="signup-department" required class="input-field">
                        <option value="" disabled selected>Select Department</option>
                        <option value="Contact Centre">Contact Centre</option>
                        <option value="Customer Service">Customer Service</option>
                    </select>
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="signup-password" placeholder="Choose a password" required class="input-field">
                </div>
                <button type="submit" class="btn-primary w-full">Sign Up</button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Already have an account? <a href="#" id="show-login" class="text-purple-600 hover:underline">Login</a>
                </p>
            </form>
        </div>
    </div>

    <div id="app-page" class="container hidden">
        <header class="flex justify-between items-center p-4 bg-purple-600 text-white shadow-md">
            <h1 class="text-2xl font-bold">Customer Experience Controls</h1>
            <div class="flex items-center space-x-4">
                <img id="header-logo-preview" class="logo-display hidden" src="" alt="Company Logo">
                <span id="user-display" class="text-sm font-medium"></span>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-md text-sm font-medium transition-colors">Logout</button>
            </div>
        </header>

        <nav class="top-nav tab-buttons">
            <button class="tab-button active" data-tab="dashboard">Dashboard</button>
            <button class="tab-button" data-tab="key-controls">Key Controls</button>
            <button class="tab-button" data-tab="secondary-controls">Secondary Controls</button>
            <button class="tab-button" data-tab="reports">Reports</button>
            <button class="tab-button" data-tab="upload-images">Upload Images</button>
            <button class="tab-button" data-tab="database">Database</button>
            <button class="tab-button" data-tab="admin">Admin</button>
        </nav>

        <main class="flex-grow p-6 overflow-hidden">
            <div id="dashboard-content" class="tab-content active">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Dashboard</h2>
                <div class="dashboard-charts-container">
                    <div class="bg-white p-6 rounded-lg shadow-md" style="width: 6in; height: 5in;">
                        <h3 class="text-xl font-medium text-gray-700 mb-4">Key Controls Status</h3>
                        <canvas id="keyControlsChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md" style="width: 6in; height: 5in;">
                        <h3 class="text-xl font-medium text-gray-700 mb-4">Secondary Controls Status</h3>
                        <canvas id="secondaryControlsChart"></canvas>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="generate-all-pdf-button" class="btn-primary">Generate All Controls PDF</button>
                </div>
            </div>

            <div id="key-controls-content" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Key Controls</h2>
                <div class="overflow-x-auto">
                    <table id="key-controls-table" class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th rowspan="3" style="width: 15%;">KEY CONTROL DESCRIPTION</th>
                                <th rowspan="3" style="width: 5%;">HOW</th>
                                <th rowspan="3" style="width: 5%;">FREQ</th>
                                <th rowspan="3" style="width: 8%;">BY WHEN</th>
                                <th rowspan="3" style="width: 10%;">EVIDENCE OF CONTROL</th>
                                <th colspan="12">Months</th>
                                <th rowspan="3" style="width: 5%;">Annual</th>
                                <th rowspan="3" style="width: 8%;">Tracking Status</th>
                                <th rowspan="3" style="width: 10%;">Link</th>
                                <th colspan="2" rowspan="3" style="width: 10%;">Actions</th>
                                <th rowspan="3" style="width: 8%;">Due In</th>
                            </tr>
                            <tr>
                                <th colspan="3" class="table-header-quarters">Q1</th>
                                <th colspan="3" class="table-header-quarters">Q2</th>
                                <th colspan="3" class="table-header-quarters">Q3</th>
                                <th colspan="3" class="table-header-quarters">Q4</th>
                            </tr>
                            <tr>
                                <th class="table-header-months" style="width: 3%;">1</th>
                                <th class="table-header-months" style="width: 3%;">2</th>
                                <th class="table-header-months" style="width: 3%;">3</th>
                                <th class="table-header-months" style="width: 3%;">4</th>
                                <th class="table-header-months" style="width: 3%;">5</th>
                                <th class="table-header-months" style="width: 3%;">6</th>
                                <th class="table-header-months" style="width: 3%;">7</th>
                                <th class="table-header-months" style="width: 3%;">8</th>
                                <th class="table-header-months" style="width: 3%;">9</th>
                                <th class="table-header-months" style="width: 3%;">10</th>
                                <th class="table-header-months" style="width: 3%;">11</th>
                                <th class="table-header-months" style="width: 3%;">12</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div class="flex flex-wrap gap-4 mt-6 justify-end">
                    <button id="add-key-control-btn" class="btn-primary">Add New Control</button>
                    <input type="file" id="upload-key-control-file" accept=".csv" class="hidden">
                    <button id="upload-key-control-btn" class="btn-secondary">Upload Controls (CSV)</button>
                    <button id="generate-key-pdf-button" class="btn-primary">Generate PDF</button>
                    <button id="download-key-excel-button" class="btn-primary">Download as Excel</button>
                    <button id="share-key-button" class="btn-primary">Share</button>
                </div>
            </div>

            <div id="secondary-controls-content" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Secondary Controls</h2>
                <div class="overflow-x-auto">
                    <table id="secondary-controls-table" class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>How</th>
                                <th>Who</th>
                                <th>Frequency</th>
                                <th>By When</th>
                                <th>Evidence</th>
                                <th>Archived</th>
                                <th>Date of Review</th>
                                <th>Total Transactions</th>
                                <th>Samples Checked</th>
                                <th>Exceptions</th>
                                <th>Assessment</th>
                                <th>Required Action</th>
                                <th>Closure Date</th>
                                <th>URL Link</th>
                                <th>Review</th>
                                <th>Delete</th>
                                <th>Due In</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div class="flex flex-wrap gap-4 mt-6 justify-end">
                    <button id="add-secondary-control-btn" class="btn-primary">Add New Control</button>
                    <input type="file" id="upload-secondary-control-file" accept=".csv" class="hidden">
                    <button id="upload-secondary-control-btn" class="btn-secondary">Upload Controls (CSV)</button>
                    <button id="generate-secondary-pdf-button" class="btn-primary">Generate PDF</button>
                    <button id="download-secondary-excel-button" class="btn-primary">Download as Excel</button>
                    <button id="share-secondary-button" class="btn-primary">Share</button>
                </div>
            </div>
            
            <div id="reports-content" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Reports</h2>
                <iframe src="reports.html" class="w-full h-full border-0"></iframe>
            </div>

            <div id="upload-images-content" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Upload Company Images</h2>
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Select and Upload Logo</h3>
                    <input type="file" id="logo-file-input" accept="image/*" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-purple-50 file:text-purple-700
                        hover:file:bg-purple-100
                    "/>
                    <p class="mt-2 text-sm text-gray-500">The logo will be displayed on the login page, system header, and PDF reports.</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Logo Preview</h3>
                    <img id="logo-preview" class="max-h-40 w-auto rounded-lg shadow-md hidden" src="" alt="Logo Preview">
                </div>
            </div>

            <div id="admin-content" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Admin Panel</h2>
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Create New User</h3>
                    <form id="create-user-form" class="space-y-4">
                        <div>
                            <label for="new-user-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="new-user-email" placeholder="New user email" required class="input-field">
                        </div>
                         <div>
                            <label for="new-user-fullname" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" id="new-user-fullname" placeholder="New user full name" required class="input-field">
                        </div>
                        <div>
                            <label for="new-user-department" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                            <select id="new-user-department" required class="input-field">
                                <option value="" disabled selected>Select Department</option>
                                <option value="Contact Centre">Contact Centre</option>
                                <option value="Customer Service">Customer Service</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-user-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="new-user-password" placeholder="New user password" required class="input-field">
                        </div>
                        <button type="submit" class="btn-primary">Create User</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Current Users</h3>
                    <ul id="user-list" class="list-disc pl-5 text-gray-700">
                         </ul>
                </div>
            </div>

            <div id="database-content" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Generated PDF Database</h2>
                <div class="overflow-x-auto">
                    <table id="pdf-database-table" class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th class="w-10"><input type="checkbox" class="form-checkbox"></th>
                                <th>Date Generated</th>
                                <th>Month</th>
                                <th>Control Type</th>
                                <th>Attachment</th>
                                <th class="w-24">Download</th>
                                <th class="w-24">Delete</th>
                                <th class="w-24">Share</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>

                <h2 class="text-2xl font-semibold text-gray-800 mt-12 mb-6">Verified Controls</h2>
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Upload Signed Document</h3>
                    <form id="verified-control-form" class="space-y-4">
                        <div>
                            <label for="verified-control-type" class="block text-sm font-medium text-gray-700 mb-1">Control Type</label>
                            <select id="verified-control-type" required class="input-field">
                                <option value="" disabled selected>Select Control Type</option>
                                <option value="Key Controls">Key Controls</option>
                                <option value="Secondary Controls">Secondary Controls</option>
                            </select>
                        </div>
                        <div>
                            <label for="verified-control-month" class="block text-sm font-medium text-gray-700 mb-1">Month</label>
                            <select id="verified-control-month" required class="input-field">
                                <option value="" disabled selected>Select Month</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        <div>
                            <label for="verified-control-file" class="block text-sm font-medium text-gray-700 mb-1">Signed Document</label>
                            <input type="file" id="verified-control-file" required class="block w-full text-sm text-gray-500"/>
                        </div>
                        <button type="submit" class="btn-primary">Upload Document</button>
                    </form>
                </div>
                <div class="overflow-x-auto">
                    <table id="verified-controls-table" class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th>Control Type</th>
                                <th>Month</th>
                                <th>Date Uploaded</th>
                                <th>Document</th>
                                <th>Download</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="control-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4">Add New Control</h3>
            <form id="control-form" class="space-y-4">
                <div class="flex justify-end mt-6">
                    <button type="submit" class="btn-primary">Save Control</button>
                    <button type="button" id="cancel-control-modal" class="btn-secondary ml-2">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="link-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Add Link</h3>
            <form id="link-form" class="space-y-4">
                <div>
                    <label for="link-name-input" class="block text-sm font-medium text-gray-700 mb-1">Link Name</label>
                    <input type="text" id="link-name-input" class="input-field" placeholder="e.g., Google Drive">
                </div>
                <div>
                    <label for="link-url-input" class="block text-sm font-medium text-gray-700 mb-1">Link URL</label>
                    <input type="url" id="link-url-input" class="input-field" placeholder="e.g., https://drive.google.com/folder">
                    </div>
                    <div class="flex justify-end mt-6">
                        <button type="submit" class="btn-primary">Save Link</button>
                        <button type="button" id="cancel-link-modal" class="btn-secondary ml-2">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="pdf-export-content" class="pdf-export-content">
            <div id="pdf-content-wrapper">
                <div class="flex justify-between items-start mb-6">
                    <div>
                         <h1 class="text-2xl font-bold">Customer Experience Controls Report</h1>
                         <p>Prepared by: <span id="pdf-user-name" class="font-medium"></span></p>
                    </div>
                    <img id="pdf-logo-preview" class="max-h-20 w-auto" src="" alt="Company Logo">
                </div>
                <h2 id="pdf-report-title" class="text-xl font-semibold mt-8 mb-4"></h2>
                <div class="overflow-x-auto">
                    <table id="pdf-table-to-generate" class="min-w-full bg-white border border-gray-200">
                        </table>
                </div>
                <table class="pdf-signoff-table">
                    <thead>
                        <tr>
                            <th style="width: 50%; border-bottom: 2px solid black;">Assistant Manager -</th>
                            <th style="width: 50%; border-bottom: 2px solid black;">Group Manager - Customer Experience</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <p>Name: <span id="signoff-assistant-name">Darius Kedera</span></p>
                                <p>Signature & Date:</p>
                                <div class="signature-box"></div>
                            </td>
                            <td>
                                <p>Name: <span id="signoff-group-manager-name">Eric Muthengi</span></p>
                                <p>Signature & Date:</p>
                                <div class="signature-box"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="excel-export-content" style="display: none;">
            <table id="excel-table-to-generate"></table>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import {
                getAuth,
                signInAnonymously,
                signInWithCustomToken,
                onAuthStateChanged,
                createUserWithEmailAndPassword,
                signInWithEmailAndPassword,
                signOut,
                sendPasswordResetEmail
            } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import {
                getFirestore,
                collection,
                doc,
                setDoc,
                addDoc,
                updateDoc,
                deleteDoc,
                onSnapshot,
                query,
                where,
                getDocs,
                writeBatch,
                getDoc
            } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
            
            document.addEventListener('DOMContentLoaded', () => {

                let app;
                let db;
                let auth;
                let storage;
                let currentUserId = null;
                let logoDataUrl = '';
                const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                const monthsInNumbers = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
                const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
                let currentUserData = {};
                
                let keyControlsChart, secondaryControlsChart;
                let currentLinkCell = null;

                const keyControlHeaders = [
                    { id: 'KEY CONTROL DESCRIPTION', label: 'Description', type: 'text' },
                    { id: 'HOW', label: 'How', type: 'text' },
                    { id: 'FREQ', label: 'Frequency', type: 'select', options: ['Daily', 'Weekly', 'Monthly', 'Quarterly', 'Annually'] },
                    { id: 'BY WHEN', label: 'By When', type: 'date' },
                    { id: 'EVIDENCE OF CONTROL', label: 'Evidence of Control', type: 'text' },
                    { id: 'JAN', label: '1', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'FEB', label: '2', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'MAR', label: '3', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'APR', label: '4', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'MAY', label: '5', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'JUN', label: '6', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'JUL', label: '7', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'AUG', label: '8', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'SEP', label: '9', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'OCT', label: '10', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'NOV', label: '11', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'DEC', label: '12', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'Annual', label: 'Annual', type: 'select', options: ['Y', 'N', '-'] },
                    { id: 'Tracking Status', label: 'Tracking Status', type: 'select', options: ['On Track', 'Overdue', 'Pending'] },
                    { id: 'Link', label: 'Link', type: 'link' },
                ];
                
                const secondaryControlHeaders = [
                    { id: 'KEY CONTROL DESCRIPTION', label: 'Description', type: 'text' },
                    { id: 'HOW (i.e. Manual/ Automated)', label: 'How', type: 'text' },
                    { id: 'WHO (i.e. Title of reviewer)', label: 'Who', type: 'text' },
                    { id: 'FREQUENCY e.g. Daily, Weekly, Monthly', label: 'Frequency', type: 'select', options: ['Daily', 'Weekly', 'Monthly', 'Quarterly', 'Annually'] },
                    { id: 'BY WHEN (TATs e.g. by 10th of ever month)', label: 'By When', type: 'date' },
                    { id: 'EVIDENCE OF CONTROL e.g What is signed-off?', label: 'Evidence', type: 'text' },
                    { id: 'HOW CONTROL EVIDENCE IS ARCHIVED e.g Shared folder/EDMS', label: 'Archived', type: 'text' },
                    { id: 'Date of Review', label: 'Date of Review', type: 'date' },
                    { id: 'Total number of transactions (where applicable)', label: 'Total Transactions', type: 'number' },
                    { id: 'Samples checked (Where Applicable)', label: 'Samples Checked', type: 'text' },
                    { id: 'Exceptions from sampled items (Where none, indicate NONE)', label: 'Exceptions', type: 'text' },
                    { id: 'Assessment of Effectiveness of Control from Review (INDICATE: Effective, Partially Effective or Not Effective)', label: 'Assessment', type: 'select', options: ['Effective', 'Partially Effective', 'Not Effective'] },
                    { id: 'Required Action', label: 'Required Action', type: 'text' },
                    { id: 'Closure Date', label: 'Closure Date', type: 'date' },
                    { id: 'Tracking Status', label: 'Tracking Status', type: 'select', options: ['On Track', 'Overdue', 'Pending'] },
                    { id: 'Link', label: 'URL Link', type: 'link' }
                ];
                
                let controlData = {
                    keyControls: [],
                    secondaryControls: [],
                    generatedPdfs: [],
                    verifiedControls: []
                };
                
                function showLoadingSpinner() {
                    const spinner = document.getElementById('loading-spinner');
                    if (spinner) spinner.style.display = 'block';
                }

                function hideLoadingSpinner() {
                    const spinner = document.getElementById('loading-spinner');
                    if (spinner) spinner.style.display = 'none';
                }

                function showMessage(message, duration = 3000) {
                    const msgBox = document.getElementById('message-box');
                    if (msgBox) {
                        msgBox.textContent = message;
                        msgBox.classList.add('show');
                        setTimeout(() => {
                            msgBox.classList.remove('show');
                        }, duration);
                    }
                }

                function showModal(modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) modal.classList.add('show');
                }

                function hideModal(modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) modal.classList.remove('show');
                }
                
                async function retryOperation(operation, maxRetries = 5, delay = 1000) {
                    for (let i = 0; i < maxRetries; i++) {
                        try {
                            return await operation();
                        } catch (error) {
                            if (i < maxRetries - 1) {
                                await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                            } else {
                                throw error;
                            }
                        }
                    }
                }
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = {
                    apiKey: "AIzaSyDEK6AOeXiZVWKXw715FGkX9_yeNaKHx_8",
                    authDomain: "controls-f11f8.firebaseapp.com",
                    projectId: "controls-f11f8",
                    storageBucket: "controls-f11f8.firebasestorage.app",
                    messagingSenderId: "316152578637",
                    appId: "1:316152578637:web:b0b3c11c9821ee8bb05204",
                    measurementId: "G-793K2F5VZC"
                };

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                        const userDoc = await retryOperation(() => getDoc(userDocRef));
                        if (userDoc.exists()) {
                            currentUserData = userDoc.data();
                            document.getElementById('user-display').textContent = `User: ${currentUserData.fullName || user.email}`;
                        } else {
                            currentUserData = { department: 'unknown', fullName: 'Unknown User' };
                            document.getElementById('user-display').textContent = `User: ${user.email}`;
                        }
                        
                        document.getElementById('login-page').classList.add('hidden');
                        document.getElementById('signup-page').classList.add('hidden');
                        document.getElementById('app-page').classList.remove('hidden');
                        
                        await loadControls('keyControls', 'key-controls-table');
                        await loadControls('secondaryControls', 'secondary-controls-table');
                        await loadPdfs();
                        await loadVerifiedControls();
                        await loadUsers();
                        loadLogo();
                        renderDashboardCharts();
                    } else {
                        currentUserId = null;
                        currentUserData = {};
                        document.getElementById('login-page').classList.remove('hidden');
                        document.getElementById('signup-page').classList.add('hidden');
                        document.getElementById('app-page').classList.add('hidden');
                    }
                    hideLoadingSpinner();
                });

                async function initialSignIn() {
                    showLoadingSpinner();
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await retryOperation(() => signInWithCustomToken(auth, __initial_auth_token));
                        } else {
                            await retryOperation(() => signInAnonymously(auth));
                        }
                    } catch (error) {
                        console.error("Error during initial sign-in:", error);
                        showMessage(`Authentication failed: ${error.message}`);
                    } finally {
                        hideLoadingSpinner();
                    }
                }
                initialSignIn();

                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    showLoadingSpinner();
                    try {
                        await retryOperation(() => signInWithEmailAndPassword(auth, email, password));
                        showMessage('Logged in successfully!');
                    } catch (error) {
                        console.error("Login error:", error);
                        showMessage(`Login failed: ${error.message}`);
                    } finally {
                        hideLoadingSpinner();
                    }
                });
                
                document.getElementById('signup-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    const fullName = document.getElementById('signup-fullname').value;
                    const department = document.getElementById('signup-department').value;
                    showLoadingSpinner();
                    try {
                        const userCredential = await retryOperation(() => createUserWithEmailAndPassword(auth, email, password));
                        const user = userCredential.user;
                        await retryOperation(() => setDoc(doc(db, `artifacts/${appId}/users`, user.uid), {
                            email: email,
                            fullName: fullName,
                            department: department
                        }));
                        showMessage('Account created and logged in successfully!');
                    } catch (error) {
                        console.error("Signup error:", error);
                        showMessage(`Signup failed: ${error.message}`);
                    } finally {
                        hideLoadingSpinner();
                    }
                });

                document.getElementById('show-signup').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('login-page').classList.add('hidden');
                    document.getElementById('signup-page').classList.remove('hidden');
                });

                document.getElementById('show-login').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('signup-page').classList.add('hidden');
                    document.getElementById('login-page').classList.remove('hidden');
                });

                document.getElementById('logout-button').addEventListener('click', async () => {
                    showLoadingSpinner();
                    try {
                        await retryOperation(() => signOut(auth));
                        showMessage('Logged out successfully!');
                    } catch (error) {
                        console.error("Logout error:", error);
                        showMessage(`Logout failed: ${error.message}`);
                    } finally {
                        hideLoadingSpinner();
                    }
                });

                document.getElementById('forgot-password').addEventListener('click', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    if (!email) {
                        showMessage('Please enter your email address to reset your password.');
                        return;
                    }
                    showLoadingSpinner();
                    try {
                        await retryOperation(() => sendPasswordResetEmail(auth, email));
                        showMessage(`Password reset email sent to ${email}. Please check your inbox.`);
                    } catch (error) {
                        console.error("Forgot password error:", error);
                        showMessage(`Failed to send reset email: ${error.message}`);
                    } finally {
                        hideLoadingSpinner();
                    }
                });

                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                        button.classList.add('active');
                        document.getElementById(`${button.dataset.tab}-content`).classList.add('active');
                    });
                });
                
                function openLinkModal(cell) {
                    currentLinkCell = cell;
                    const controlId = cell.closest('tr').dataset.id;
                    const controlType = cell.closest('table').id.includes('key') ? 'keyControls' : 'secondaryControls';
                    const control = controlData[controlType].find(c => c.id === controlId);
                    const linkNameInput = document.getElementById('link-name-input');
                    const linkUrlInput = document.getElementById('link-url-input');

                    linkNameInput.value = control?.['Link Name'] || '';
                    linkUrlInput.value = control?.['Link URL'] || '';
                    
                    showModal('link-modal');
                }
                
                document.getElementById('link-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const linkName = document.getElementById('link-name-input').value;
                    const linkUrl = document.getElementById('link-url-input').value;

                    if (currentLinkCell) {
                        const controlId = currentLinkCell.closest('tr').dataset.id;
                        const controlType = currentLinkCell.closest('table').id.includes('key') ? 'keyControls' : 'secondaryControls';
                        const controlsColRef = collection(db, `artifacts/${appId}/public/data/${controlType}`);
                        
                        try {
                            await updateDoc(doc(controlsColRef, controlId), {
                                'Link Name': linkName,
                                'Link URL': linkUrl
                            });
                            showMessage('Link updated successfully!');
                        } catch (error) {
                            console.error("Error updating link:", error);
                            showMessage(`Failed to update link: ${error.message}`);
                        }
                    }
                    hideModal('link-modal');
                });
                
                document.getElementById('cancel-link-modal').addEventListener('click', () => {
                    hideModal('link-modal');
                });

                async function loadControls(collectionName, tableId) {
                    if (!currentUserId || !currentUserData.department) return;
                    const controlsColRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                    
                    const q = query(controlsColRef, where('Department', '==', currentUserData.department));
                    
                    onSnapshot(q, (snapshot) => {
                        const controls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        controlData[collectionName] = controls;
                        renderControlsTable(controls, tableId, collectionName);
                        if (collectionName === 'keyControls' || collectionName === 'secondaryControls') {
                            renderDashboardCharts();
                        }
                    }, (error) => {
                        console.error(`Error fetching ${collectionName}:`, error);
                        showMessage(`Failed to load ${collectionName}: ${error.message}`);
                    });
                }

                async function loadPdfs() {
                    if (!currentUserId) return;
                    const pdfsColRef = collection(db, `artifacts/${appId}/public/data/generatedPdfs`);
                    // Assuming permissive rules, no 'where' clause is needed here.
                    const q = query(pdfsColRef);
                    onSnapshot(q, (snapshot) => {
                        const pdfs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        controlData.generatedPdfs = pdfs;
                        renderPdfsTable(pdfs);
                    }, (error) => {
                        console.error(`Error fetching PDFs:`, error);
                        showMessage(`Failed to load PDF records: ${error.message}`);
                    });
                }

                async function loadVerifiedControls() {
                    if (!currentUserId) return;
                    const verifiedControlsColRef = collection(db, `artifacts/${appId}/public/data/verifiedControls`);
                    // Assuming permissive rules, no 'where' clause is needed here.
                    const q = query(verifiedControlsColRef);
                    onSnapshot(q, (snapshot) => {
                        const verifiedControls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        controlData.verifiedControls = verifiedControls;
                        renderVerifiedControlsTable(verifiedControls);
                    }, (error) => {
                        console.error(`Error fetching verified controls:`, error);
                        showMessage(`Failed to load verified controls: ${error.message}`);
                    });
                }
                
                function renderPdfsTable(pdfs) {
                    const tableBody = document.querySelector('#pdf-database-table tbody');
                    if (!tableBody) return;
                    tableBody.innerHTML = '';
                    pdfs.forEach(pdf => {
                        const row = tableBody.insertRow();
                        const checkboxCell = row.insertCell();
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.classList.add('form-checkbox');
                        checkboxCell.appendChild(checkbox);

                        row.insertCell().textContent = pdf.date;
                        row.insertCell().textContent = pdf.month;
                        row.insertCell().textContent = pdf.controlType;

                        const attachmentCell = row.insertCell();
                        const downloadLink = document.createElement('a');
                        downloadLink.href = pdf.downloadUrl;
                        downloadLink.textContent = pdf.fileName;
                        downloadLink.target = '_blank';
                        downloadLink.classList.add('text-blue-600', 'hover:underline');
                        attachmentCell.appendChild(downloadLink);

                        const downloadCell = row.insertCell();
                        const downloadBtn = document.createElement('button');
                        downloadBtn.textContent = 'Download';
                        downloadBtn.classList.add('btn-primary', 'py-1', 'px-2', 'text-xs');
                        downloadBtn.onclick = () => window.open(pdf.downloadUrl, '_blank');
                        downloadCell.appendChild(downloadBtn);

                        const deleteCell = row.insertCell();
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.classList.add('delete-btn');
                        deleteBtn.onclick = () => deletePdf(pdf.id);
                        deleteCell.appendChild(deleteBtn);

                        const shareCell = row.insertCell();
                        const shareBtn = document.createElement('button');
                        shareBtn.textContent = 'Share';
                        shareBtn.classList.add('btn-primary');
                        shareBtn.onclick = () => sharePdf(pdf.id);
                        shareCell.appendChild(shareBtn);
                    });
                }
                
                async function deletePdf(pdfId) {
                    const confirmed = window.confirm('Are you sure you want to delete this PDF record?');
                    if (!confirmed) return;
                    try {
                        await retryOperation(() => deleteDoc(doc(db, `artifacts/${appId}/public/data/generatedPdfs`, pdfId)));
                        showMessage('PDF record deleted successfully!');
                    } catch (error) {
                        console.error(`Error deleting PDF record:`, error);
                        showMessage(`Failed to delete PDF record: ${error.message}`);
                    }
                }
                
                function sharePdf(pdfId) {
                    const pdfRecord = controlData.generatedPdfs.find(p => p.id === pdfId);
                    if (!pdfRecord) {
                        showMessage('PDF record not found.');
                        return;
                    }
                    const subject = `Control Report: ${pdfRecord.controlType} - ${pdfRecord.month} ${pdfRecord.date.split('-')[0]}`;
                    const body = `Please find the attached PDF report for ${pdfRecord.controlType} from ${pdfRecord.month} ${pdfRecord.date.split('-')[0]}.`;
                    
                    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    showMessage('Opening email client. Please manually attach the downloaded PDF.');
                }

                function getStatusColorClass(status) {
                    if (status === 'Y' || status === 'On Track' || status === 'Effective') {
                        return 'status-green';
                    } else if (status === 'N' || status === 'Overdue' || status === 'Not Effective') {
                        return 'status-red';
                    } else if (status === '-' || status === 'Pending' || status === 'Partially Effective') {
                        return 'status-amber';
                    } else if (status === 'Closed') {
                        return 'status-gray';
                    }
                    return '';
                }

                function renderStatusCell(cell, status, control, headerId, collectionName) {
                    const statusText = document.createElement('span');
                    const statusValue = status || '-'; 
                    statusText.textContent = statusValue;
                    
                    const colorClass = getStatusColorClass(statusValue) || '';
                    
                    statusText.classList.add('status-text', colorClass);
                    
                    cell.appendChild(statusText);
                    cell.classList.add('status-cell');

                    cell.addEventListener('click', async (e) => {
                        const newStatus = prompt(`Enter new status for ${headerId} (Y, N, -):`, status || '-');
                        if (newStatus !== null && ['Y', 'N', '-'].includes(newStatus)) {
                            const data = { [headerId]: newStatus };
                            try {
                                const controlsColRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                                await updateDoc(doc(controlsColRef, control.id), data);
                                showMessage('Status updated successfully!');
                            } catch (error) {
                                console.error("Error updating status:", error);
                                showMessage(`Failed to update status: ${error.message}`);
                            }
                        }
                    });
                }
                
                function updateStatusOnDateChange(control, collectionName) {
                    const byWhenDateStr = control['BY WHEN'];
                    if (byWhenDateStr && control['Tracking Status'] !== 'Overdue' && control['Tracking Status'] !== 'Closed') {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const byWhenDate = new Date(byWhenDateStr);
                        if (byWhenDate < today) {
                            const controlsColRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                            updateDoc(doc(controlsColRef, control.id), { 'Tracking Status': 'Overdue' })
                                .catch(error => console.error("Error updating status to Overdue:", error));
                        }
                    }
                }

                function renderControlsTable(controls, tableId, collectionName) {
                    const tableBody = document.querySelector(`#${tableId} tbody`);
                    if (!tableBody) return;
                    tableBody.innerHTML = '';
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const headersToUse = collectionName === 'keyControls' ? keyControlHeaders : secondaryControlHeaders;

                    controls.forEach(control => {
                        const row = tableBody.insertRow();
                        row.dataset.id = control.id;
                        
                        let byWhenDateStr = control['BY WHEN'];
                        let dueInDays = '-';
                        let overdueClass = '';

                        if (byWhenDateStr) {
                            const byWhenDate = new Date(byWhenDateStr);
                            byWhenDate.setHours(0, 0, 0, 0);
                            const diffTime = byWhenDate.getTime() - today.getTime();
                            dueInDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            if (byWhenDate < today) {
                                overdueClass = 'overdue-text';
                                if(collectionName === 'keyControls' && control['Tracking Status'] !== 'Overdue') {
                                     updateStatusOnDateChange(control, collectionName);
                                }
                            }
                        }
                        
                        headersToUse.forEach(header => {
                            const cell = row.insertCell();
                            if (header.id === 'Link') {
                                const linkName = control['Link Name'];
                                const linkURL = control['Link URL'];
                                const linkText = linkName || 'Add Link';
                                const linkClass = linkName ? 'text-blue-600 hover:underline' : 'text-gray-500';
                                
                                const linkButton = document.createElement('button');
                                linkButton.textContent = linkText;
                                linkButton.classList.add('p-1', 'rounded', ...linkClass.split(' '));
                                linkButton.onclick = () => openLinkModal(cell);
                                cell.classList.add('link-cell');
                                cell.appendChild(linkButton);
                            } else if (months.includes(header.id) || header.id === 'Annual' || header.id === 'Tracking Status' || header.id === 'Assessment') {
                                renderStatusCell(cell, control[header.id], control, header.id, collectionName);
                            } else {
                                const value = control[header.id] || '';
                                const inputElement = document.createElement(header.type === 'select' ? 'select' : 'input');
                                inputElement.classList.add('input-field', 'w-full', 'text-sm');

                                if (header.type === 'select') {
                                     header.options.forEach(optionText => {
                                         const option = document.createElement('option');
                                         option.value = optionText;
                                         option.textContent = optionText;
                                         inputElement.appendChild(option);
                                     });
                                } else {
                                     inputElement.type = header.type;
                                }
                                
                                inputElement.value = value;
                                cell.appendChild(inputElement);

                                const originalValue = inputElement.value;
                                inputElement.addEventListener('blur', async () => {
                                     if (inputElement.value !== originalValue) {
                                         const newValue = inputElement.value;
                                         const data = { [header.id]: newValue };
                                         await updateDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, control.id), data);
                                     }
                                });
                            }
                        });

                        const reviewCell = row.insertCell();
                        const reviewBtn = document.createElement('button');
                        reviewBtn.textContent = 'Review';
                        reviewBtn.classList.add('review-btn');
                        reviewBtn.onclick = () => openControlModal(collectionName, control.id, control);
                        reviewCell.appendChild(reviewBtn);
                        
                        const deleteCell = row.insertCell();
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.classList.add('delete-btn');
                        deleteBtn.onclick = () => deleteControl(collectionName, control.id);
                        deleteCell.appendChild(deleteBtn);

                        const dueInCell = row.insertCell();
                        if (!isNaN(dueInDays)) {
                            dueInCell.textContent = dueInDays;
                        } else {
                            dueInCell.textContent = '-';
                        }
                        dueInCell.classList.add(overdueClass);
                    });
                }


                async function addOrUpdateControl(collectionName, controlId, data) {
                    showLoadingSpinner();
                    try {
                        const controlsColRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                        
                        const dataToSave = {...data};
                        
                        if (!controlId) {
                            if (collectionName === 'keyControls') {
                                ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC', 'Annual'].forEach(monthId => {
                                    if (!dataToSave[monthId]) {
                                        dataToSave[monthId] = '-';
                                    }
                                });
                                if (!dataToSave['Tracking Status']) {
                                         dataToSave['Tracking Status'] = 'Pending';
                                }
                            }
                        }
                        
                        const linkName = dataToSave['Link Name'];
                        const linkURL = dataToSave['Link URL'];
                        if (!linkName || linkName.trim() === '') {
                            delete dataToSave['Link Name'];
                            delete dataToSave['Link URL'];
                        }

                        if (controlId) {
                            await retryOperation(() => updateDoc(doc(controlsColRef, controlId), dataToSave));
                            showMessage('Control updated successfully!');
                        } else {
                            if(currentUserData.department) {
                               dataToSave.Department = currentUserData.department;
                            }
                            await retryOperation(() => addDoc(controlsColRef, dataToSave));
                            showMessage('Control added successfully!');
                        }
                    } catch (error) {
                        console.error(`Error saving control to ${collectionName}:`, error);
                        showMessage(`Failed to save control: ${error.message}`);
                    } finally {
                        hideLoadingSpinner();
                        hideModal('control-modal');
                    }
                }

                async function deleteControl(collectionName, controlId) {
                    const confirmed = window.confirm('Are you sure you want to delete this control?');
                    if (!confirmed) return;

                    showLoadingSpinner();
                    try {
                        const controlsColRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                        await retryOperation(() => deleteDoc(doc(controlsColRef, controlId)));
                        showMessage('Control deleted successfully!');
                    } catch (error) {
                        console.error(`Error deleting control from ${collectionName}:`, error);
                        showMessage(`Failed to delete control: ${error.message}`);
                    } finally {
                        hideLoadingSpinner();
                    }
                }

                let currentControlType = '';
                let currentControlId = null;

                function openControlModal(type, id = null, data = {}) {
                    currentControlType = type;
                    currentControlId = id;
                    
                    const modalTitle = document.getElementById('modal-title');
                    const controlForm = document.getElementById('control-form');
                    if (!controlForm || !modalTitle) return;
                    controlForm.innerHTML = '';
                    modalTitle.textContent = id ? 'Edit Control' : 'Add New Control';

                    let headersToUse = type === 'keyControls' ? keyControlHeaders : secondaryControlHeaders;
                    
                    headersToUse.forEach(header => {
                        if (header.id === 'Link') {
                            return;
                        }
                        
                        const div = document.createElement('div');
                        div.classList.add('mb-4');

                        const label = document.createElement('label');
                        label.htmlFor = `form-${header.id}`;
                        label.classList.add('block', 'text-sm', 'font-medium', 'text-gray-700', 'mb-1');
                        label.textContent = header.label;
                        div.appendChild(label);

                        let inputElement;
                        if (header.type === 'select' && header.options) {
                            inputElement = document.createElement('select');
                            inputElement.id = `form-${header.id}`;
                            inputElement.classList.add('input-field');
                            header.options.forEach(optionText => {
                                const option = document.createElement('option');
                                option.value = optionText;
                                option.textContent = optionText;
                                inputElement.appendChild(option);
                            });
                            inputElement.value = data[header.id] || '';
                        } else if (header.type === 'date') {
                            inputElement = document.createElement('input');
                            inputElement.type = 'date';
                            inputElement.id = `form-${header.id}`;
                            inputElement.classList.add('input-field');
                            inputElement.value = data[header.id] || '';
                        } else {
                            inputElement = document.createElement('input');
                            inputElement.type = header.type || 'text';
                            inputElement.id = `form-${header.id}`;
                            inputElement.classList.add('input-field');
                            inputElement.value = data[header.id] || '';
                        }
                        
                        div.appendChild(inputElement);
                        controlForm.appendChild(div);
                    });
                    
                    const linkNameHeader = { id: 'Link Name', label: 'Link Name', type: 'text' };
                    const linkUrlHeader = { id: 'Link URL', label: 'Link URL', type: 'url' };
                    
                    const linkNameDiv = document.createElement('div');
                    linkNameDiv.classList.add('mb-4');
                    linkNameDiv.innerHTML = `<label for="form-${linkNameHeader.id}" class="block text-sm font-medium text-gray-700 mb-1">${linkNameHeader.label}</label><input type="${linkNameHeader.type}" id="form-${linkNameHeader.id}" class="input-field" value="${data[linkNameHeader.id] || ''}">`;
                    controlForm.appendChild(linkNameDiv);

                    const linkUrlDiv = document.createElement('div');
                    linkUrlDiv.classList.add('mb-4');
                    linkUrlDiv.innerHTML = `<label for="form-${linkUrlHeader.id}" class="block text-sm font-medium text-gray-700 mb-1">${linkUrlHeader.label}</label><input type="${linkUrlHeader.type}" id="form-${linkUrlHeader.id}" class="input-field" value="${data[linkUrlHeader.id] || ''}">`;
                    controlForm.appendChild(linkUrlDiv);

                    const buttonDiv = document.createElement('div');
                    buttonDiv.classList.add('flex', 'justify-end', 'mt-6');
                    
                    const saveButton = document.createElement('button');
                    saveButton.type = 'submit';
                    saveButton.classList.add('btn-primary');
                    saveButton.textContent = 'Save Control';
                    buttonDiv.appendChild(saveButton);

                    const cancelButton = document.createElement('button');
                    cancelButton.type = 'button';
                    cancelButton.id = 'cancel-control-modal';
                    cancelButton.classList.add('btn-secondary', 'ml-2');
                    cancelButton.textContent = 'Cancel';
                    cancelButton.onclick = () => hideModal('control-modal');
                    buttonDiv.appendChild(cancelButton);

                    controlForm.appendChild(buttonDiv);
                    
                    showModal('control-modal');
                }

                document.getElementById('control-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = {};
                    let headersToUse = currentControlType === 'keyControls' ? keyControlHeaders : secondaryControlHeaders;
                    
                    headersToUse.forEach(header => {
                        if (header.id === 'Link') {
                            return;
                        }
                        const inputElement = document.getElementById(`form-${header.id}`);
                        if (inputElement) {
                            formData[header.id] = inputElement.value;
                        }
                    });
                    
                    const linkNameInput = document.getElementById('form-Link Name');
                    const linkUrlInput = document.getElementById('form-Link URL');
                    if (linkNameInput) formData['Link Name'] = linkNameInput.value;
                    if (linkUrlInput) formData['Link URL'] = linkUrlInput.value;

                    await addOrUpdateControl(currentControlType, currentControlId, formData);
                });

                document.getElementById('add-key-control-btn').addEventListener('click', () => openControlModal('keyControls'));
                document.getElementById('add-secondary-control-btn').addEventListener('click', () => openControlModal('secondaryControls'));

                async function parseCSV(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const text = event.target.result;
                            const lines = text.split('\n').filter(line => line.trim() !== '');
                            if (lines.length === 0) {
                                reject(new Error("CSV file is empty or malformed."));
                                return;
                            }
                            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                            const data = [];
                            for (let i = 1; i < lines.length; i++) {
                                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                                if (values.length === headers.length) {
                                    const row = {};
                                    headers.forEach((header, index) => {
                                        row[header] = values[index];
                                    });
                                    data.push(row);
                                } else if (values.length > 1) {
                                    console.warn(`Skipping malformed row ${i + 1}: Expected ${headers.length} columns, got ${values.length}. Row: ${lines[i]}`);
                                }
                            }
                            resolve(data);
                        };
                        reader.onerror = (error) => reject(error);
                        reader.readAsText(file);
                    });
                }

                async function uploadControls(fileInputId, collectionName) {
                    const fileInput = document.getElementById(fileInputId);
                    const file = fileInput.files[0];
                    if (!file) {
                        showMessage('Please select a CSV file to upload.');
                        return;
                    }

                    showLoadingSpinner();
                    try {
                        const parsedData = await parseCSV(file);
                        if (parsedData.length === 0) {
                            showMessage('No valid data found in the CSV file.');
                            return;
                        }

                        const controlsColRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                        const batch = writeBatch(db);
                        let uploadCount = 0;

                        parsedData.forEach(item => {
                            const newDocRef = doc(controlsColRef);
                            if(currentUserData.department) {
                               item.Department = currentUserData.department;
                            }
                            batch.set(newDocRef, item);
                            uploadCount++;
                        });

                        await retryOperation(() => batch.commit());
                        showMessage(`Successfully uploaded ${uploadCount} controls to ${collectionName}.`);
                    } catch (error) {
                        console.error(`Error uploading controls to ${collectionName}:`, error);
                        showMessage(`Failed to upload controls: ${error.message}`);
                    } finally {
                        hideLoadingSpinner();
                        fileInput.value = '';
                    }
                }

                document.getElementById('upload-key-control-btn').addEventListener('click', () => {
                    document.getElementById('upload-key-control-file').click();
                });
                document.getElementById('upload-key-control-file').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        uploadControls('upload-key-control-file', 'keyControls');
                    }
                });

                document.getElementById('upload-secondary-control-btn').addEventListener('click', () => {
                    document.getElementById('upload-secondary-control-file').click();
                });
                document.getElementById('upload-secondary-control-file').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        uploadControls('upload-secondary-control-file', 'secondaryControls');
                    }
                });
                
                document.getElementById('share-key-button').addEventListener('click', () => {
                    const latestPdf = controlData.generatedPdfs
                        .filter(p => p.controlType === 'Key Controls')
                        .sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                    if(latestPdf) {
                        sharePdf(latestPdf.id);
                    } else {
                        showMessage('No recent Key Controls PDF found to share.');
                    }
                });
                
                document.getElementById('share-secondary-button').addEventListener('click', () => {
                    const latestPdf = controlData.generatedPdfs
                        .filter(p => p.controlType === 'Secondary Controls')
                        .sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                    if(latestPdf) {
                        sharePdf(latestPdf.id);
                    } else {
                        showMessage('No recent Secondary Controls PDF found to share.');
                    }
                });
                
                function loadLogo() {
                    const logoPreview = document.getElementById('logo-preview');
                    const loginLogo = document.getElementById('login-logo-preview');
                    const headerLogo = document.getElementById('header-logo-preview');
                    const pdfLogo = document.getElementById('pdf-logo-preview');
                    
                    const logoUrl = localStorage.getItem('companyLogo');
                    if(logoUrl) {
                        logoDataUrl = logoUrl;
                        logoPreview.src = logoUrl;
                        logoPreview.classList.remove('hidden');
                        loginLogo.src = logoUrl;
                        loginLogo.classList.remove('hidden');
                        headerLogo.src = logoUrl;
                        headerLogo.classList.remove('hidden');
                        pdfLogo.src = logoUrl;
                    }
                }
                
                document.getElementById('logo-file-input').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const logoUrl = event.target.result;
                            localStorage.setItem('companyLogo', logoUrl);
                            loadLogo();
                            showMessage('Logo uploaded successfully!');
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                function getStatusCounts(controls, collectionName) {
                    const counts = {};
                    controls.forEach(control => {
                        const status = control['Tracking Status'] || control['Assessment'] || '-';
                        counts[status] = (counts[status] || 0) + 1;
                    });
                    return counts;
                }

                function renderChart(chartId, title, dataCounts) {
                    const ctx = document.getElementById(chartId).getContext('2d');
                    const labels = Object.keys(dataCounts);
                    const data = Object.values(dataCounts);

                    const colors = [
                        '#34d399',
                        '#f87171',
                        '#fbbf24',
                        '#6b7280',
                        '#8b5cf6',
                        '#3b82f6'
                    ];
                    
                    const backgroundColors = labels.map(label => {
                        switch(label) {
                            case 'On Track': return '#34d399';
                            case 'Overdue': return '#f87171';
                            case 'Pending': return '#fbbf24';
                            case 'Closed': return '#6b7280';
                            case 'Y': return '#34d399';
                            case 'N': return '#f87171';
                            case '-': return '#fbbf24';
                            case 'Effective': return '#34d399';
                            case 'Partially Effective': return '#fbbf24';
                            case 'Not Effective': return '#f87171';
                            default: return '#e5e7eb';
                        }
                    });

                    let existingChart = Chart.getChart(ctx);
                    if (existingChart) {
                        existingChart.destroy();
                    }
                    
                    return new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Number of Controls',
                                data: data,
                                backgroundColor: backgroundColors,
                                borderColor: 'white',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: title
                                }
                            }
                        }
                    });
                }

                function renderDashboardCharts() {
                    const keyCounts = getStatusCounts(controlData.keyControls, 'keyControls');
                    if (keyControlsChart) keyControlsChart.destroy();
                    keyControlsChart = renderChart('keyControlsChart', 'Key Controls Status Distribution', keyCounts);

                    const secondaryCounts = getStatusCounts(controlData.secondaryControls, 'secondaryControls');
                    if (secondaryControlsChart) secondaryControlsChart.destroy();
                    secondaryControlsChart = renderChart('secondaryControlsChart', 'Secondary Controls Status Distribution', secondaryCounts);
                }

                async function createUser(email, password, fullName, department) {
                    showLoadingSpinner();
                    try {
                        const userCredential = await retryOperation(() => createUserWithEmailAndPassword(auth, email, password));
                        const user = userCredential.user;
                        await retryOperation(() => setDoc(doc(db, `artifacts/${appId}/users`, user.uid), {
                            email: email,
                            fullName: fullName,
                            department: department
                        }));
                        showMessage(`User ${email} created successfully!`);
                        document.getElementById('create-user-form').reset();
                        await loadUsers();
                    } catch (error) {
                        console.error("Error creating user:", error);
                        showMessage(`Failed to create user: ${error.message}`);
                    } finally {
                        hideLoadingSpinner();
                    }
                }

                document.getElementById('create-user-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('new-user-email').value;
                    const password = document.getElementById('new-user-password').value;
                    const fullName = document.getElementById('new-user-fullname').value;
                    const department = document.getElementById('new-user-department').value;
                    await createUser(email, password, fullName, department);
                });

                async function loadUsers() {
                    const userList = document.getElementById('user-list');
                    if (!userList) return;
                    userList.innerHTML = '';
                    
                    const usersColRef = collection(db, `artifacts/${appId}/users`);
                    const usersSnapshot = await retryOperation(() => getDocs(usersColRef));
                    
                    if (usersSnapshot.empty) {
                        const listItem = document.createElement('li');
                        listItem.textContent = `No users found.`;
                        userList.appendChild(listItem);
                        return;
                    }

                    usersSnapshot.forEach(userDoc => {
                        const user = userDoc.data();
                        const listItem = document.createElement('li');
                        listItem.textContent = `${user.fullName} (${user.email}) - ${user.department}`;
                        userList.appendChild(listItem);
                    });
                }
                
                function renderVerifiedControlsTable(verifiedControls) {
                    const tableBody = document.querySelector('#verified-controls-table tbody');
                    if (!tableBody) return;
                    tableBody.innerHTML = '';
                    verifiedControls.forEach(doc => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = doc.controlType;
                        row.insertCell().textContent = doc.month;
                        row.insertCell().textContent = doc.date;
                        
                        const docCell = row.insertCell();
                        const docLink = document.createElement('a');
                        docLink.href = doc.downloadUrl;
                        docLink.textContent = doc.fileName;
                        docLink.target = '_blank';
                        docCell.appendChild(docLink);

                        const downloadCell = row.insertCell();
                        const downloadBtn = document.createElement('button');
                        downloadBtn.textContent = 'Download';
                        downloadBtn.classList.add('btn-primary', 'py-1', 'px-2', 'text-xs');
                        downloadBtn.onclick = () => window.open(doc.downloadUrl, '_blank');
                        downloadCell.appendChild(downloadBtn);
                    });
                }

                document.getElementById('verified-control-form').addEventListener('submit', handleVerifiedDocumentUpload);
                
                async function handleVerifiedDocumentUpload(e) {
                    e.preventDefault();
                    showLoadingSpinner();
                    
                    const controlType = document.getElementById('verified-control-type').value;
                    const month = document.getElementById('verified-control-month').value;
                    const fileInput = document.getElementById('verified-control-file');
                    const file = fileInput.files[0];
                    
                    if (!file || !controlType || !month) {
                        showMessage('Please fill all fields and select a file.');
                        hideLoadingSpinner();
                        return;
                    }
                    
                    try {
                        const storageRef = ref(storage, `verified-controls/${controlType}/${month}/${file.name}`);
                        const snapshot = await uploadBytes(storageRef, file);
                        const downloadUrl = await getDownloadURL(snapshot.ref);
                        
                        const docData = {
                            controlType: controlType,
                            month: month,
                            fileName: file.name,
                            downloadUrl: downloadUrl,
                            date: new Date().toISOString().slice(0, 10)
                        };
                        
                        await addDoc(collection(db, `artifacts/${appId}/public/data/verifiedControls`), docData);
                        
                        showMessage('Document uploaded successfully!');
                        document.getElementById('verified-control-form').reset();
                    } catch (error) {
                        console.error('Error uploading document:', error);
                        showMessage(`Failed to upload document: ${error.message}`);
                    } finally {
                        hideLoadingSpinner();
                    }
                }


                document.getElementById('generate-key-pdf-button').addEventListener('click', () => generatePdfForControls('keyControls'));
                document.getElementById('generate-secondary-pdf-button').addEventListener('click', () => generatePdfForControls('secondaryControls'));
                document.getElementById('generate-all-pdf-button').addEventListener('click', () => generatePdfForControls('all'));

                async function generatePdfForControls(type) {
                    const pdfExportContent = document.getElementById('pdf-export-content');
                    const pdfTable = document.getElementById('pdf-table-to-generate');
                    const pdfReportTitle = document.getElementById('pdf-report-title');
                    const pdfLogoPreview = document.getElementById('pdf-logo-preview');
                    const pdfUserName = document.getElementById('pdf-user-name');
                    
                    showLoadingSpinner();

                    let controlsToPrint = [];
                    let title = '';

                    if (type === 'keyControls') {
                        controlsToPrint = controlData.keyControls;
                        title = 'Key Controls Report';
                    } else if (type === 'secondaryControls') {
                        controlsToPrint = controlData.secondaryControls;
                        title = 'Secondary Controls Report';
                    } else if (type === 'all') {
                        controlsToPrint = controlData.keyControls.concat(controlData.secondaryControls);
                        title = 'All Controls Report';
                    }
                    
                    if (pdfUserName) {
                         pdfUserName.textContent = currentUserData.fullName || 'N/A';
                    }
                    
                    if(pdfReportTitle) pdfReportTitle.textContent = title;
                    populatePdfTable(pdfTable, controlsToPrint, type);
                    if (logoDataUrl) {
                        pdfLogoPreview.src = logoDataUrl;
                        pdfLogoPreview.classList.remove('hidden');
                    } else {
                        pdfLogoPreview.classList.add('hidden');
                    }
                    
                    if(pdfExportContent) pdfExportContent.style.display = 'block';
                    
                    const options = {
                        margin: 10,
                        filename: `${title.replace(/ /g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                        jsPDF: { unit: 'mm', format: 'a3', orientation: 'landscape' }
                    };

                    await html2pdf().set(options).from(pdfExportContent).save().then(async (pdf) => {
                        if(pdfExportContent) pdfExportContent.style.display = 'none';
                        showMessage('PDF generated successfully!');
                        
                        const pdfRecord = {
                            date: new Date().toISOString().slice(0, 10),
                            month: new Date().toLocaleString('default', { month: 'long' }),
                            controlType: title.replace(' Report', ''),
                            fileName: `${title.replace(/ /g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`,
                            downloadUrl: URL.createObjectURL(pdf.output('blob'))
                        };
                        await addDoc(collection(db, `artifacts/${appId}/public/data/generatedPdfs`), pdfRecord);
                    }).catch(error => {
                        console.error("Error generating PDF:", error);
                        showMessage(`Failed to generate PDF: ${error.message}`);
                        if(pdfExportContent) pdfExportContent.style.display = 'none';
                    });
                    hideLoadingSpinner();
                }

                function populatePdfTable(tableElement, controls, controlType) {
                    if (!tableElement) return;
                    const tableHeader = tableElement.querySelector('thead') || tableElement.createTHead();
                    const tableBody = tableElement.querySelector('tbody') || tableElement.createTBody();
                    tableHeader.innerHTML = '';
                    tableBody.innerHTML = '';

                    if (controlType === 'keyControls' || controlType === 'all') {
                        const topRow = tableHeader.insertRow();
                        const middleRow = tableHeader.insertRow();
                        const bottomRow = tableHeader.createTHead().insertRow();

                        const mainHeaders = [
                            'KEY CONTROL DESCRIPTION', 'HOW', 'FREQ', 'BY WHEN', 'EVIDENCE OF CONTROL'
                        ];
                        mainHeaders.forEach(h => {
                            const th = document.createElement('th');
                            th.textContent = h;
                            th.rowSpan = 3;
                            topRow.appendChild(th);
                        });

                        const monthsHeader = document.createElement('th');
                        monthsHeader.textContent = 'Months';
                        monthsHeader.colSpan = 12;
                        topRow.appendChild(monthsHeader);

                        const annTrackLinkHeaders = ['Annual', 'Tracking Status', 'Link', 'Actions', 'Due In'];
                        annTrackLinkHeaders.forEach(h => {
                            const th = document.createElement('th');
                            th.textContent = h;
                            th.rowSpan = 3;
                            topRow.appendChild(th);
                        });

                        const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
                        quarters.forEach(q => {
                            const th = document.createElement('th');
                            th.textContent = q;
                            th.colSpan = 3;
                            middleRow.appendChild(th);
                        });

                        const monthHeaders = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
                        monthHeaders.forEach(month => {
                            const thMonth = document.createElement('th');
                            thMonth.textContent = month;
                            thMonth.style.width = '3%';
                            bottomRow.appendChild(thMonth);
                        });
                    } else if (controlType === 'secondaryControls') {
                        const headerRow = tableHeader.insertRow();
                        const headersToUse = secondaryControlHeaders.map(h => h.label);
                        headersToUse.forEach(header => {
                             const th = document.createElement('th');
                             th.textContent = header;
                             headerRow.appendChild(th);
                        });
                        const thActions = document.createElement('th');
                        thActions.textContent = "Actions";
                        headerRow.appendChild(thActions);
                        const thDueIn = document.createElement('th');
                        thDueIn.textContent = "Due In";
                        headerRow.appendChild(thDueIn);
                    }
                    
                    controls.forEach(control => {
                        const row = tableBody.insertRow();
                        const today = new Date();
                        const byWhenDateStr = control['BY WHEN'];
                        let dueInDays = '-';
                        let overdueClass = '';

                        if (byWhenDateStr) {
                            const byWhenDate = new Date(byWhenDateStr);
                            if (!isNaN(byWhenDate.getTime())) { // Check if date is valid
                                byWhenDate.setHours(0, 0, 0, 0);
                                const diffTime = byWhenDate.getTime() - today.getTime();
                                dueInDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                if (byWhenDate < today) {
                                    overdueClass = 'overdue-text';
                                }
                            }
                        }
                        
                        if (controlType === 'keyControls' || controlType === 'all') {
                            const cellsToRender = [
                                'KEY CONTROL DESCRIPTION', 'HOW', 'FREQ', 'BY WHEN', 'EVIDENCE OF CONTROL'
                            ];
                            cellsToRender.forEach(key => {
                                const cell = row.insertCell();
                                cell.textContent = control[key] || '';
                            });
                            months.forEach(month => {
                                const cell = row.insertCell();
                                cell.textContent = control[month] || '-';
                            });
                            const annualCell = row.insertCell();
                            annualCell.textContent = control['Annual'] || '-';
                            const trackingStatusCell = row.insertCell();
                            trackingStatusCell.textContent = control['Tracking Status'] || '';

                            const linkCell = row.insertCell();
                            const linkName = control['Link Name'];
                            const linkURL = control['Link URL'];
                            if (linkName && linkURL) {
                                const anchor = document.createElement('a');
                                anchor.href = linkURL;
                                anchor.textContent = linkName;
                                anchor.target = '_blank';
                                linkCell.appendChild(anchor);
                            } else {
                                linkCell.textContent = linkName || '';
                            }

                            const actionsCell = row.insertCell();
                            actionsCell.textContent = 'Review / Delete';
                            const dueInCell = row.insertCell();
                            if (!isNaN(dueInDays)) {
                                dueInCell.textContent = dueInDays;
                            } else {
                                dueInCell.textContent = '-';
                            }
                            dueInCell.classList.add(overdueClass);

                        } else if (controlType === 'secondaryControls') {
                            const cellsToRender = [
                                'KEY CONTROL DESCRIPTION', 'HOW (i.e. Manual/ Automated)', 'WHO (i.e. Title of reviewer)', 'FREQUENCY e.g. Daily, Weekly, Monthly', 'BY WHEN (TATs e.g. by 10th of ever month)', 'EVIDENCE OF CONTROL e.g What is signed-off?', 'HOW CONTROL EVIDENCE IS ARCHIVED e.g Shared folder/EDMS', 'Date of Review', 'Total number of transactions (where applicable)', 'Samples checked (Where Applicable)', 'Exceptions from sampled items (Where none, indicate NONE)', 'Assessment of Effectiveness of Control from Review (INDICATE: Effective, Partially Effective or Not Effective)', 'Required Action', 'Closure Date', 'Link'
                            ];
                            cellsToRender.forEach(headerId => {
                                const cell = row.insertCell();
                                if (headerId === 'Link') {
                                    const linkName = control['Link Name'];
                                    const linkURL = control['Link URL'];
                                    if (linkName && linkURL) {
                                        const anchor = document.createElement('a');
                                        anchor.href = linkURL;
                                        anchor.textContent = linkName;
                                        anchor.target = '_blank';
                                        cell.appendChild(anchor);
                                    } else {
                                        cell.textContent = linkName || '';
                                    }
                                } else {
                                    cell.textContent = control[headerId] || '';
                                }
                            });
                            const actionsCell = row.insertCell();
                            actionsCell.textContent = 'Review / Delete';
                            const dueInCell = row.insertCell();
                            if (!isNaN(dueInDays)) {
                                dueInCell.textContent = dueInDays;
                            } else {
                                dueInCell.textContent = '-';
                            }
                            dueInCell.classList.add(overdueClass);
                        }
                    });
                }

                document.getElementById('download-key-excel-button').addEventListener('click', () => {
                     downloadExcel('keyControls');
                });
                document.getElementById('download-secondary-excel-button').addEventListener('click', () => {
                     downloadExcel('secondaryControls');
                });

                function downloadExcel(controlType) {
                    const tableId = controlType === 'keyControls' ? 'key-controls-table' : 'secondary-controls-table';
                    const tableName = controlType === 'keyControls' ? 'Key Controls' : 'Secondary Controls';
                    const table = document.getElementById(tableId);

                    const ws = XLSX.utils.table_to_sheet(table);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, tableName);
                    
                    XLSX.writeFile(wb, `${tableName}_Report_${new Date().toISOString().slice(0, 10)}.xlsx`);
                }
            });
        </script>
    </body>
</html>
